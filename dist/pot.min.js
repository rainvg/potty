var nappy=require("nappy"),wrench=require("wrench"),confio=require("confio"),path=require("path"),needle=require("needle"),child_process=require("child_process"),randomstring=require("randomstring"),genocide=require("genocide"),fs=require("fs"),os=require("os"),unzip=require("unzip");module.exports=function e(t,n,r,i){"use strict";var o={id:{length:16},path_setup:{retry:1e3},remote_version:{retry:1e3},fetch:{retry:{min:1e3,max:6048e5},tmp_file_length:16},update:{retry:{min:1e3,max:6048e5}},start:{autoupdate:{threshold:6048e5},keepalive:{interval:500,margin:10,sleep_threshold:5e3},sentence:2e3,log:{max_length:1048576}}};if(!(this instanceof e))throw{code:0,description:"Constructor must be called with new.",url:""};var a=this,s={root:t,app:path.resolve(t,"app"),resources:path.resolve(t,"resources")},c=n,d="string"==typeof r?{command:r}:r;d.args=d.args||[],d.env=d.env||{};var u=i||{},p=u.log?u.log:function(){};p("Potty booting.");var f=new confio.confio(path.resolve(s.root,"potty.json"),path.resolve(__dirname,"..","config","pot.min.json")),l={start:function(){},data:function(){},message:function(){},error:function(){},shutdown:function(){},reboot:function(){},update:function(){}},h={message:function(){},bury:function(){}};a.path={root:function(){return s.root},app:function(){return s.app},resources:function(){return s.resources}},a.remote=function(){return c},a.id=function(){if(""===f.get("id"))try{f.set("id",randomstring.generate(o.id.length))}catch(e){}return f.get("id")},a.on=function(e,t){if(!(e in l))throw{code:2,description:"Event does not exist.",url:""};l[e]=t},a.message=function(e){p("Sending",e,"to the app."),h.message(e)},a.bury=function(){p("Burying the app upon request."),h.bury()};var g=function(){return p("Checking online status."),new Promise(function(e){needle.get("https://api.ipify.org",function(t,n){!t&&200===n.statusCode&&/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$|^(([a-zA-Z]|[a-zA-Z][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z]|[A-Za-z][A-Za-z0-9\-]*[A-Za-z0-9])$|^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$/.test(n.body)?(p("App online."),e(!0)):(p("App offline"),e(!1))})})},m=function(){return p("Setting up path."),new Promise(function(e){!function t(){try{for(var n in s)wrench.mkdirSyncRecursive(s[n]);"win32"===process.platform&&child_process.exec("attrib +h "+s.root),p("Path set up."),e()}catch(r){p("Error setting up path:",r,"(waiting and retrying)."),nappy.wait["for"](o.path_setup.retry).then(t)}}()})},v=function(e){return p("Trying to unzip."),new Promise(function(t,n){try{wrench.rmdirSyncRecursive(s.app),fs.createReadStream(e).pipe(unzip.Extract({path:s.app})).on("finish",function(){p("Unzip succeeded."),t()}).on("error",function(e){p("Error unzipping:",e),n()})}catch(r){p("Error unzipping:",r),n()}})},y=function(){p("Fetching latest release.");var e=function(){return p("Attempting download."),new Promise(function(e,t){nappy.wait.connection().then(function(){p("Connection available. Fetching package info."),needle.get(c+"?id="+a.id(),function(n,r){(n||200!==r.statusCode)&&(p("Error fetching package info:",n||r.statusCode),t(n));try{p("Package info successfully fetched.");var i=JSON.parse(r.body);i.tmp={path:path.resolve(os.tmpdir(),randomstring.generate(o.fetch.tmp_file_length))},p("Downloading",i.latest.url,"to",i.tmp.path),needle.get(i.latest.url,{output:i.tmp.path},function(n,r){(n||200!==r.statusCode)&&(p("Error downloading:",n||r.statusCode),t(n)),p("Download successful."),e(i.tmp.path)})}catch(n){p("Error parsing package info:",n),t(n)}})})})};return new Promise(function(t){!function n(){m().then(function(){return p("Waiting for next fetch retry"),nappy.wait.till(f.get("fetch_last")+Math.min(Math.pow(2,f.get("fetch_retries"))*o.fetch.retry.min,o.fetch.retry.max))}).then(function(){try{f.set("fetch_last",(new Date).getTime())}catch(e){}}).then(e).then(v).then(function(){try{f.set("fetch_retries",0)}catch(e){}p("Fetch successful."),t()})["catch"](function(){p("Fetch failed. Retrying.");try{f.set("fetch_retries",f.get("fetch_retries")+1)}catch(e){}n()})}()})},w=function(){p("Fetching app version.");try{delete require.cache[require.resolve(path.resolve(s.app,"package.json"))];var e=require(path.resolve(s.app,"package.json")).version;return p("App version is",e),e}catch(t){return p("No version found, returning ''"),""}},_=function(){p("Fetching remote version.");var e=function(){return p("Trying to fetch remote version."),new Promise(function(e,t){needle.get(c+"?id="+a.id(),function(n,r){(n||200!==r.statusCode)&&(p("Error fetching remote version:",n||r.statusCode),t(n));try{var i=JSON.parse(r.body);p("Remote version is",i.version),e(i.version)}catch(n){p("Error parsing package info:",n),t(n)}})})};return new Promise(function(t){!function n(){e().then(t)["catch"](function(){p("Failed fetching remote version. Retrying."),nappy.wait["for"](o.remote_version.retry).then(n)})}()})},A=function(e){return p(e?"Updating forcefully.":"Updating."),new Promise(function(t){if(!e&&(new Date).getTime()<f.get("update_last")+Math.min(Math.pow(2,f.get("update_vain"))*o.update.retry.min,o.update.retry.max))return p("Last update too recent. Resolving."),void t(!1);try{f.set("update_last",(new Date).getTime())}catch(n){}_().then(function(e){if(e===w()){p("Remote version and app version are the same.");try{f.set("update_vain",f.get("update_vain")+1)}catch(n){}t(!1)}else{p("Remote version is different from app version. Fetching.");try{f.set("update_vain",0)}catch(n){}y().then(function(){p("Update completed."),t(!0)})}})})},F=function(e){return p("Installing",e),new Promise(function(t){v(e).then(function(){p("Installed successfully."),t(!0)})["catch"](function(){p("Installation failed. Updating."),A(!0).then(t)})})};a.start=function(){function e(){p("Setting environment variables and params.");var t=process.env;for(var n in d.env)"undefined"==typeof d.env[n]?delete process.env[n]:process.env[n]=d.env[n];p("Spawning app.");var r=child_process.spawn(d.command,d.args,{cwd:s.resources,detached:!0,stdio:["pipe","pipe","pipe","ipc"]});process.env=t;var i=null,c=null,f={stdout:"",stderr:""};r.stdout.on("data",function(e){e.toString("utf8").split(/\r?\n/).forEach(function(e){e.length&&p("[app]",e)}),l.data(e),f.stdout+=e,f.stdout.length>o.start.log.max_length&&(f.stdout=f.stdout.slice(f.stdout.length-o.start.log.max_length))}),r.stderr.on("data",function(e){e.toString("utf8").split(/\r?\n/).forEach(function(e){e.length&&p("[app] [err]",e)}),f.stderr+=e,f.stderr.length>o.start.log.max_length&&(f.stderr=f.stderr.slice(f.stderr.length-o.start.log.max_length))});var g=function(t){if(!r.buried){if(p("Burying app with reason",t),h.message=function(){},h.bury=function(){},r.buried=!0,u.keepalive){try{m.alarm.abort()}catch(n){}clearInterval(m.interval)}p("Calling genocide on app."),genocide.genocide(r.pid),{"null":function(){p("No will found. Updating."),l.error({reason:t,log:f}),A().then(e)},shutdown:function(){p("Shutdown requested."),l.shutdown()},reboot:function(){p("Reboot requested."),l.reboot(),e()},update:function(){p("Update requested."),A(!0).then(function(t){t||l.reboot(),e()})},install:function(){p("Install requested on",c.path),F(c.path).then(function(t){t||l.reboot(),e()})}}[i]()}};if(r.on("close",function(e,t){g({event:"close",code:e,signal:t})}),r.on("disconnect",function(){g({event:"disconnect"})}),r.on("error",function(e){g({event:"error",error:e})}),r.on("exit",function(e,t){g({event:"exit",code:e,signal:t})}),u.keepalive){var m={alarm:new nappy.alarm(o.start.keepalive.margin*o.start.keepalive.interval,{sleep_threshold:o.start.keepalive.sleep_threshold}),interval:setInterval(function(){r.send({cmd:"keepalive"})},o.start.keepalive.interval)};m.alarm.then(function(){p("Keepalive timeout. Calling genocide."),genocide.genocide(r.pid)})}r.on("message",function(e){if("start"!==e.cmd||r.started)if(u.keepalive&&"keepalive"===e.cmd)try{m.alarm.reset()}catch(t){}else if("shutdown"===e.cmd||"reboot"===e.cmd||"update"===e.cmd||"install"===e.cmd){if(p("Received message:",e.cmd,"requested"),i=e.cmd,c=e.meta,r.send({cmd:"goodnight"}),u.keepalive){try{m.alarm.abort()}catch(t){}clearInterval(m.interval)}nappy.wait["for"](o.start.sentence).then(function(){r.buried||(p("Child still alive. Sentencing it."),i=null,genocide.genocide(r.pid))})}else"message"===e.cmd&&(p("Received message:",e.message),l.message(e.message));else r.started=!0,r.send({cmd:"setup",id:a.id(),version:u.version||"0.0.0"}),l.start()}),h.message=function(e){r.send({cmd:"message",message:e})},h.bury=function(){g({event:"bury"})}}p("Start called."),g().then(function(t){t?(p("App online. Doing on-boot update."),A().then(e)):e()})}};