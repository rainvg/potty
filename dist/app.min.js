var nappy=require("nappy"),path=require("path"),genocide=require("genocide"),version=require(path.resolve(__dirname,"..","package.json")).version;module.exports=function e(n,s){"use strict";if(!(this instanceof e))throw{code:0,description:"Constructor must be called with new.",url:""};var t=n,o=s||{};try{var r=require(t);if("function"!=typeof r)throw{code:3,description:"App is not a function.",url:""};if(o.test)r({id:"[test]",version:version,shutdown:function(){return o.test.shutdown&&o.test.shutdown(),Promise.resolve()},reboot:function(){return o.test.reboot&&o.test.reboot(),Promise.resolve()},update:function(){return o.test.update&&o.test.update(),Promise.resolve()},install:function(e){return o.test.install&&o.test.install(e),Promise.resolve()},message:function(e){o.test.message&&o.test.message(e)},on:function(e){if(!(e in c))throw{code:2,description:"Event does not exist.",url:""};console.log("Subscribed to",e,"(will never be fired).")}});else{var i={keepalive:{interval:500,margin:10,sleep_threshold:5e3},sentence:2e3},c={message:function(){}};if(process.send({cmd:"start"}),o.keepalive){var a={alarm:new nappy.alarm(i.keepalive.margin*i.keepalive.interval,{sleep_threshold:i.keepalive.sleep_threshold})};a.alarm.then(genocide.seppuku)}var u=!1;process.on("message",function(e){if(o.keepalive&&"keepalive"===e.cmd){try{a.alarm.reset()}catch(n){}process.send({cmd:"keepalive"})}else if("setup"!==e.cmd||u)"message"===e.cmd&&c.message(e.message);else{u=!0;var s=function(){if(o.keepalive)try{a.alarm.abort()}catch(e){}nappy.wait["for"](i.sentence).then(genocide.seppuku)};r({id:e.id,version:{main:e.version,potty:version},shutdown:function(){return new Promise(function(e){s(),process.send({cmd:"shutdown"}),process.on("message",function(n){"goodnight"===n.cmd&&e()})})},reboot:function(){return new Promise(function(e){s(),process.send({cmd:"reboot"}),process.on("message",function(n){"goodnight"===n.cmd&&e()})})},update:function(){return new Promise(function(e){s(),process.send({cmd:"update"}),process.on("message",function(n){"goodnight"===n.cmd&&e()})})},install:function(e){return new Promise(function(n){s(),process.send({cmd:"install",meta:{path:e}}),process.on("message",function(e){"goodnight"===e.cmd&&n()})})},on:function(e,n){if(!(e in c))throw{code:2,description:"Event does not exist.",url:""};c[e]=n},message:function(e){process.send({cmd:"message",message:e})}})}})}}catch(d){console.log("Exiting with error",d),genocide.seppuku()}};