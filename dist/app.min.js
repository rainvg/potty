var nappy=require("nappy"),path=require("path"),genocide=require("genocide"),version=require(path.resolve(__dirname,"..","package.json")).version;module.exports=function e(n,t){"use strict";if(!(this instanceof e))throw{code:0,description:"Constructor must be called with new.",url:""};var s=this,o=n,i=t||{};try{var r=require(o);if("function"!=typeof r)throw{code:3,description:"App is not a function.",url:""};if(i.test)s.start=function(){r({id:"[test]",version:version,shutdown:function(){return i.test.shutdown&&i.test.shutdown(),Promise.resolve()},reboot:function(){return i.test.reboot&&i.test.reboot(),Promise.resolve()},update:function(){return i.test.update&&i.test.update(),Promise.resolve()},install:function(e){return i.test.install&&i.test.install(e),Promise.resolve()},message:function(e){i.test.message&&i.test.message(e)},on:function(e){if(!(e in a))throw{code:2,description:"Event does not exist.",url:""};console.log("Subscribed to",e,"(will never be fired).")}})};else{var c={keepalive:{interval:500,margin:10,sleep_threshold:5e3},sentence:2e3},a={message:function(){}};s.start=function(){if(process.send({cmd:"start"}),i.keepalive){var e={alarm:new nappy.alarm(c.keepalive.margin*c.keepalive.interval,{sleep_threshold:c.keepalive.sleep_threshold})};e.alarm.then(genocide.seppuku)}var n=!1;process.on("message",function(t){if(i.keepalive&&"keepalive"===t.cmd){try{e.alarm.reset()}catch(s){}process.send({cmd:"keepalive"})}else if("setup"!==t.cmd||n)"message"===t.cmd&&a.message(t.message);else{n=!0;var o=function(){if(i.keepalive)try{e.alarm.abort()}catch(n){}nappy.wait["for"](c.sentence).then(genocide.seppuku)};r({id:t.id,version:{main:t.version,potty:version},shutdown:function(){return new Promise(function(e){o(),process.send({cmd:"shutdown"}),process.on("message",function(n){"goodnight"===n.cmd&&e()})})},reboot:function(){return new Promise(function(e){o(),process.send({cmd:"reboot"}),process.on("message",function(n){"goodnight"===n.cmd&&e()})})},update:function(){return new Promise(function(e){o(),process.send({cmd:"update"}),process.on("message",function(n){"goodnight"===n.cmd&&e()})})},install:function(e){return new Promise(function(n){o(),process.send({cmd:"install",meta:{path:e}}),process.on("message",function(e){"goodnight"===e.cmd&&n()})})},on:function(e,n){if(!(e in a))throw{code:2,description:"Event does not exist.",url:""};a[e]=n},message:function(e){process.send({cmd:"message",message:e})}})}})}}}catch(u){console.log("Exiting with error",u),genocide.seppuku()}};