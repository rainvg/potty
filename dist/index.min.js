var nappy=require("nappy"),wrench=require("wrench"),confio=require("confio"),path=require("path"),needle=require("needle"),child_process=require("child_process"),randomstring=require("randomstring"),genocide=require("genocide"),fs=require("fs"),os=require("os"),unzip=require("unzip"),commander=require("commander"),electron=process.versions.electron?require("electron"):null,version=require(path.resolve(__dirname,"..","package.json")).version;if(require.main!==module)module.exports=function e(t,n,r){"use strict";var o={id:{length:16},path_setup:{retry:1e3},remote_version:{retry:1e3},fetch:{retry:{min:1e3,max:6048e5},tmp_file_length:16},update:{retry:{min:1e3,max:6048e5}},start:{autoupdate:{threshold:6048e5},keepalive:{interval:500,margin:10,sleep_threshold:5e3},sentence:2e3,log:{max_length:1048576}}};if(!(this instanceof e))throw{code:0,description:"Constructor must be called with new.",url:""};var i=this,s={root:t,app:path.resolve(t,"app"),resources:path.resolve(t,"resources")},a=n,c=r||{},d=c.log?c.log:function(){};d("Potty booting.");var u=new confio.confio(path.resolve(s.root,"potty.json"),path.resolve(__dirname,"..","config","pot.json")),p={start:function(){},data:function(){},message:function(){},error:function(){},shutdown:function(){},reboot:function(){},update:function(){}},l={message:function(){},bury:function(){}};i.path={root:function(){return s.root},app:function(){return s.app},resources:function(){return s.resources}},i.remote=function(){return a},i.id=function(){if(""===u.get("id"))try{u.set("id",randomstring.generate(o.id.length))}catch(e){}return u.get("id")},i.on=function(e,t){if(!(e in p))throw{code:2,description:"Event does not exist.",url:""};p[e]=t},i.message=function(e){d("Sending",e,"to the app."),l.message(e)},i.bury=function(){d("Burying the app upon request."),l.bury()};var f=function(){return d("Checking online status."),new Promise(function(e){needle.get("https://api.ipify.org",function(t,n){!t&&200===n.statusCode&&/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$|^(([a-zA-Z]|[a-zA-Z][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z]|[A-Za-z][A-Za-z0-9\-]*[A-Za-z0-9])$|^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$/.test(n.body)?(d("App online."),e(!0)):(d("App offline"),e(!1))})})},g=function(){return d("Setting up path."),new Promise(function(e){!function t(){try{for(var n in s)wrench.mkdirSyncRecursive(s[n]);"win32"===process.platform&&child_process.exec("attrib +h "+s.root),d("Path set up."),e()}catch(r){d("Error setting up path:",r,"(waiting and retrying)."),nappy.wait["for"](o.path_setup.retry).then(t)}}()})},h=function(e){return d("Trying to unzip."),new Promise(function(t,n){try{wrench.rmdirSyncRecursive(s.app),fs.createReadStream(e).pipe(unzip.Extract({path:s.app})).on("finish",function(){d("Unzip succeeded."),t()}).on("error",function(e){d("Error unzipping:",e),n()})}catch(r){d("Error unzipping:",r),n()}})},m=function(){d("Fetching latest release.");var e=function(){return d("Attempting download."),new Promise(function(e,t){nappy.wait.connection().then(function(){d("Connection available. Fetching package info."),needle.get(a+"?id="+i.id(),function(n,r){(n||200!==r.statusCode)&&(d("Error fetching package info:",n||r.statusCode),t(n));try{d("Package info successfully fetched.");var i=JSON.parse(r.body);i.tmp={path:path.resolve(os.tmpdir(),randomstring.generate(o.fetch.tmp_file_length))},d("Downloading",i.latest.url,"to",i.tmp.path),needle.get(i.latest.url,{output:i.tmp.path},function(n,r){(n||200!==r.statusCode)&&(d("Error downloading:",n||r.statusCode),t(n)),d("Download successful."),e(i.tmp.path)})}catch(n){d("Error parsing package info:",n),t(n)}})})})};return new Promise(function(t){!function n(){g().then(function(){return d("Waiting for next fetch retry"),nappy.wait.till(u.get("fetch_last")+Math.min(Math.pow(2,u.get("fetch_retries"))*o.fetch.retry.min,o.fetch.retry.max))}).then(function(){try{u.set("fetch_last",(new Date).getTime())}catch(e){}}).then(e).then(h).then(function(){try{u.set("fetch_retries",0)}catch(e){}d("Fetch successful."),t()})["catch"](function(){d("Fetch failed. Retrying.");try{u.set("fetch_retries",u.get("fetch_retries")+1)}catch(e){}n()})}()})},v=function(){d("Fetching app version.");try{delete require.cache[require.resolve(path.resolve(s.app,"package.json"))];var e=require(path.resolve(s.app,"package.json")).version;return d("App version is",e),e}catch(t){return d("No version found, returning ''"),""}},y=function(){d("Fetching remote version.");var e=function(){return d("Trying to fetch remote version."),new Promise(function(e,t){needle.get(a+"?id="+i.id(),function(n,r){(n||200!==r.statusCode)&&(d("Error fetching remote version:",n||r.statusCode),t(n));try{var o=JSON.parse(r.body);d("Remote version is",o.version),e(o.version)}catch(n){d("Error parsing package info:",n),t(n)}})})};return new Promise(function(t){!function n(){e().then(t)["catch"](function(){d("Failed fetching remote version. Retrying."),nappy.wait["for"](o.remote_version.retry).then(n)})}()})},_=function(e){return d(e?"Updating forcefully.":"Updating."),new Promise(function(t){if(!e&&(new Date).getTime()<u.get("update_last")+Math.min(Math.pow(2,u.get("update_vain"))*o.update.retry.min,o.update.retry.max))return d("Last update too recent. Resolving."),void t(!1);try{u.set("update_last",(new Date).getTime())}catch(n){}y().then(function(e){if(e===v()){d("Remote version and app version are the same.");try{u.set("update_vain",u.get("update_vain")+1)}catch(n){}t(!1)}else{d("Remote version is different from app version. Fetching.");try{u.set("update_vain",0)}catch(n){}m().then(function(){d("Update completed."),t(!0)})}})})},w=function(e){return d("Installing",e),new Promise(function(t){h(e).then(function(){d("Installed successfully."),t(!0)})["catch"](function(){d("Installation failed. Updating."),_(!0).then(t)})})};i.start=function(){function e(){d("Setting environment variables and params.");var t=process.env;"ELECTRON_RUN_AS_NODE"in c&&(c.ELECTRON_RUN_AS_NODE?process.env.ELECTRON_RUN_AS_NODE=!0:delete process.env.ELECTRON_RUN_AS_NODE);var n=[];r.silent&&n.push("--silent"),d("Spawning app.");var a=child_process.spawn(process.argv[0],[__filename,s.app].concat(n),{cwd:s.resources,detached:!0,stdio:["pipe","pipe","pipe","ipc"]});process.env=t;var u=null,f=null,g={stdout:"",stderr:""};a.stdout.on("data",function(e){e.toString("utf8").split(/\r?\n/).forEach(function(e){e.length&&d("[app]",e)}),p.data(e),g.stdout+=e,g.stdout.length>o.start.log.max_length&&(g.stdout=g.stdout.slice(g.stdout.length-o.start.log.max_length))}),a.stderr.on("data",function(e){e.toString("utf8").split(/\r?\n/).forEach(function(e){e.length&&d("[app] [err]",e)}),g.stderr+=e,g.stderr.length>o.start.log.max_length&&(g.stderr=g.stderr.slice(g.stderr.length-o.start.log.max_length))});var h=function(t){if(!a.buried){d("Burying app with reason",t),l.message=function(){},l.bury=function(){},a.buried=!0;try{m.alarm.abort()}catch(n){}clearInterval(m.interval),d("Calling genocide on app."),genocide.genocide(a.pid),{"null":function(){d("No will found. Updating."),p.error({reason:t,log:g}),_().then(e)},shutdown:function(){d("Shutdown requested."),p.shutdown()},reboot:function(){d("Reboot requested."),p.reboot(),e()},update:function(){d("Update requested."),_(!0).then(function(t){t||p.reboot(),e()})},install:function(){d("Install requested on",f.path),w(f.path).then(function(t){t||p.reboot(),e()})}}[u]()}};a.on("close",function(e,t){h({event:"close",code:e,signal:t})}),a.on("disconnect",function(){h({event:"disconnect"})}),a.on("error",function(e){h({event:"error",error:e})}),a.on("exit",function(e,t){h({event:"exit",code:e,signal:t})});var m={alarm:new nappy.alarm(o.start.keepalive.margin*o.start.keepalive.interval,{sleep_threshold:o.start.keepalive.sleep_threshold}),interval:setInterval(function(){a.send({cmd:"keepalive"})},o.start.keepalive.interval)};m.alarm.then(function(){d("Keepalive timeout. Calling genocide."),genocide.genocide(a.pid)}),a.on("message",function(e){if("keepalive"===e.cmd){a.started||(a.started=!0,a.send({cmd:"setup",id:i.id()}),p.start());try{m.alarm.reset()}catch(t){}}else"shutdown"===e.cmd||"reboot"===e.cmd||"update"===e.cmd||"install"===e.cmd?(d("Received message:",e.cmd,"requested"),u=e.cmd,f=e.meta,a.send({cmd:"goodnight"}),nappy.wait["for"](o.start.sentence).then(function(){a.buried||(d("Child still alive. Sentencing it."),u=null,genocide.genocide(a.pid))})):"message"===e.cmd&&(d("Received message:",e.message),p.message(e.message))}),l.message=function(e){a.send({cmd:"message",message:e})},l.bury=function(){h({event:"bury"})}}d("Start called."),f().then(function(t){t?(d("App online. Doing on-boot update."),_().then(e)):e()})}};else{var __run__=function(){"use strict";if(commander.version(version).option("-t, --test","Run potty to test app").option("-s, --silent","Run in silent mode").parse(process.argv),commander.silent&&electron&&(electron.dialog.showErrorBox=function(e,t){console.log("[ErrorBox",e,"-",t,"]")}),1!==commander.args.length)console.log("App path required."),genocide.seppuku();else try{var e=require(commander.args[0]);if("function"!=typeof e)throw{code:3,description:"App is not a function.",url:""};if(commander.test)e({id:"[test]",version:version,shutdown:function(){return console.log("Shutdown requested."),Promise.resolve()},reboot:function(){return console.log("Reboot requested."),Promise.resolve()},update:function(){return console.log("Update requested."),Promise.resolve()},install:function(e){return console.log("Install requested for",e),Promise.resolve()},message:function(e){console.log("Message dispatched:",e)},on:function(e){if(!(e in n))throw{code:2,description:"Event does not exist.",url:""};console.log("Subscribed to",e,"(will never be fired).")}});else{var t={keepalive:{interval:500,margin:10,sleep_threshold:5e3},sentence:2e3},n={message:function(){}},r={alarm:new nappy.alarm(t.keepalive.margin*t.keepalive.interval,{sleep_threshold:t.keepalive.sleep_threshold})},o=!1;r.alarm.then(genocide.seppuku),process.on("message",function(i){if("keepalive"===i.cmd){try{r.alarm.reset()}catch(s){}process.send({cmd:"keepalive"})}else if("setup"!==i.cmd||o)"message"===i.cmd&&n.message(i.message);else{o=!0;var a=function(){try{r.alarm.abort()}catch(e){}nappy.wait["for"](t.sentence).then(genocide.seppuku)};e({id:i.id,version:version,shutdown:function(){return new Promise(function(e){a(),process.send({cmd:"shutdown"}),process.on("message",function(t){"goodnight"===t.cmd&&e()})})},reboot:function(){return new Promise(function(e){a(),process.send({cmd:"reboot"}),process.on("message",function(t){"goodnight"===t.cmd&&e()})})},update:function(){return new Promise(function(e){a(),process.send({cmd:"update"}),process.on("message",function(t){"goodnight"===t.cmd&&e()})})},install:function(e){return new Promise(function(t){a(),process.send({cmd:"install",meta:{path:e}}),process.on("message",function(e){"goodnight"===e.cmd&&t()})})},on:function(e,t){if(!(e in n))throw{code:2,description:"Event does not exist.",url:""};n[e]=t},message:function(e){process.send({cmd:"message",message:e})}})}})}}catch(i){console.log("Exiting with error",i),genocide.seppuku()}};electron?electron.app.on("ready",__run__):__run__()}