function pot(t,e,n){"use strict";var r={path_setup:{retry:1e3},setup:{retry:{min:1e3,max:6048e5}},pull:{retries:5}};if(!(this instanceof pot))throw{code:0,description:"Constructor must be called with new.",url:""};var o=this,i={root:t,app:path.resolve(t,"app"),resources:path.resolve(t,"resources")},u=e,a={local:n,remote:"origin/"+n},c=new confio.confio(path+"/potty.json",__dirname+"/../config/pot.json");o.path={root:function(){return i.root},app:function(){return i.app},resources:function(){return i.resources}},o.repository=function(){return u},o.branch={local:function(){return a.local},remote:function(){return a.remote}};var f=function(){var t=function(t){return new Promise(function(e,n){rimraf(t,function(){mkdirp(t,function(t){t?n(t):e()})})})};return new Promise(function(e){!function n(){t(i.app).then(function(){return t(i.resources)}).then(e)["catch"](function(){wait["for"](r.path_setup.retry).then(n)})}()})},s=function(){var t=function(){return wait.connection().then(function(){return nodegit.Clone(u,i.app,{checkoutBranch:a.local})})};return f().then(function(){return new Promise(function(e){wait.till(c.get("setup_last")+Math.min(Math.pow(2,c.get("setup_retries"))*r.setup.retry.min,r.setup.retry.max)).then(function(){try{c.set("setup_last",(new Date).getTime())}catch(n){}t().then(function(){try{c.set("setup_retries",0)}catch(t){}e()})["catch"](function(){try{c.set("setup_retries",c.get("setup_retries")+1)}catch(t){}s().then(e)})})})})},d=function(){var t=function(){return wait.connection().then(function(){return nodegit.Repository.open(i.app)}).then(function(t){return t.fetch("origin").then(function(){return t.mergeBranches(a.local,a.remote)})})};return new Promise(function(e){var n=0;!function o(){n<r.pull.retries?t().then(e)["catch"](function(){n++,o()}):s().then(e)}()})};o.update=function(){return d()}}var request=require("request"),nodegit=require("nodegit"),rimraf=require("rimraf"),mkdirp=require("mkdirp"),confio=require("confio"),path=require("path"),wait={"for":function(t){"use strict";return 0>t?Promise.resolve():new Promise(function(e){setTimeout(e,t)})},till:function(t){"use strict";return wait["for"](t-(new Date).getTime())},connection:function(){"use strict";var t={retry:1e3};return new Promise(function(e){!function n(){request("https://api.ipify.org",function(r,o,i){!r&&200===o.statusCode&&/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$|^(([a-zA-Z]|[a-zA-Z][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z]|[A-Za-z][A-Za-z0-9\-]*[A-Za-z0-9])$|^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$/.test(i)?e():wait["for"](t.retry).then(n)})}()})}};module.exports={pot:pot};