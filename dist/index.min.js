function pot(e,t,n){"use strict";var r={id:{length:16},path_setup:{retry:1e3},remote_version:{retry:1e3},fetch:{retry:{min:1e3,max:6048e5},tmp_file_length:16},update:{retry:{min:1e3,max:6048e5}},start:{autoupdate:{threshold:6048e5},keepalive:{interval:500,margin:10,sleep_threshold:5e3},sentence:2e3,log:{max_length:1048576}}};if(!(this instanceof pot))throw{code:0,description:"Constructor must be called with new.",url:""};var o=this,s={root:e,app:path.resolve(e,"app"),resources:path.resolve(e,"resources")},i=t,a=n||{},c=new confio.confio(path.resolve(s.root,"potty.json"),path.resolve(__dirname,"..","config","pot.json")),p={start:function(){},data:function(){},message:function(){},error:function(){},shutdown:function(){},reboot:function(){},update:function(){}},u={message:function(){},bury:function(){}};o.path={root:function(){return s.root},app:function(){return s.app},resources:function(){return s.resources},distro:function(){return s.distro}},o.remote=function(){return i},o.id=function(){if(""===c.get("id"))try{c.set("id",randomstring.generate(r.id.length))}catch(e){}return c.get("id")},o.on=function(e,t){if(!(e in p))throw{code:2,description:"Event does not exist.",url:""};p[e]=t},o.message=function(e){u.message(e)},o.bury=function(){u.bury()};var d=function(){return new Promise(function(e){!function t(){try{for(var n in s)wrench.mkdirSyncRecursive(s[n]);e()}catch(o){nappy.wait["for"](r.path_setup.retry).then(t)}}()})},h=function(){var e=function(){return new Promise(function(e,t){nappy.wait.connection().then(function(){request(i+"?id="+o.id(),function(n,o,s){(n||200!==o.statusCode)&&t(n);try{var i=JSON.parse(s);i.tmp={},i.tmp.path=path.resolve(process.env.TMPDIR,randomstring.generate(r.fetch.tmp_file_length)),i.tmp.handle=fs.createWriteStream(i.tmp.path),request(i.latest.url).on("response",function(e){i.tmp.response=e}).on("error",t).on("complete",function(){200!==i.tmp.response.statusCode?t(i.tmp.response):e(i.tmp.path)}).pipe(i.tmp.handle)}catch(n){t(n)}})})})},t=function(e){return new Promise(function(t,n){try{wrench.rmdirSyncRecursive(s.app),fs.createReadStream(e).pipe(unzip.Extract({path:s.app})).on("finish",t).on("error",n)}catch(r){n()}})};return new Promise(function(n){!function o(){d().then(function(){return nappy.wait.till(c.get("fetch_last")+Math.min(Math.pow(2,c.get("fetch_retries"))*r.fetch.retry.min,r.fetch.retry.max))}).then(function(){try{c.set("fetch_last",(new Date).getTime())}catch(e){}}).then(e).then(t).then(function(){try{c.set("fetch_retries",0)}catch(e){}n()})["catch"](function(){try{c.set("fetch_retries",c.get("fetch_retries")+1)}catch(e){}o()})}()})},f=function(){try{return require(path.resolve(s.app,"package.json")).version}catch(e){return""}},l=function(){var e=function(){return new Promise(function(e,t){request(i+"?id="+o.id(),function(n,r,o){(n||200!==r.statusCode)&&t(n);try{var s=JSON.parse(o);e(s.version)}catch(n){t(n)}})})};return new Promise(function(t){!function n(){e().then(t)["catch"](function(){nappy.wait["for"](r.remote_version.retry).then(n)})}()})},m=function(e){return new Promise(function(t){if(!e&&(new Date).getTime()<c.get("update_last")+Math.min(Math.pow(2,c.get("update_vain"))*r.update.retry.min,r.update.retry.max))return void t();try{c.set("update_last",(new Date).getTime())}catch(n){}l().then(function(e){if(e===f()){try{c.set("update_vain",c.get("update_vain")+1)}catch(n){}t()}else{try{c.set("update_vain",0)}catch(n){}h().then(t)}})})};o.start=function(){function e(){var t=process.env;"ELECTRON_RUN_AS_NODE"in a&&(a.ELECTRON_RUN_AS_NODE?process.env.ELECTRON_RUN_AS_NODE=!0:delete process.env.ELECTRON_RUN_AS_NODE),process.env.POTTY=__filename;var n=child_process.spawn(process.argv[0],[s.app],{cwd:s.resources,detached:!0,stdio:["pipe","pipe","pipe","ipc"]});process.env=t;var i=null,c={stdout:"",stderr:""};n.stdout.on("data",function(e){p.data(e),c.stdout+=e,c.stdout.length>r.start.log.max_length&&(c.stdout=c.stdout.slice(c.stdout.length-r.start.log.max_length))}),n.stderr.on("data",function(e){c.stderr+=e,c.stderr.length>r.start.log.max_length&&(c.stderr=c.stderr.slice(c.stderr.length-r.start.log.max_length))});var d=function(t){if(!n.buried){u.message=function(){},u.bury=function(){},n.buried=!0;try{h.alarm.abort()}catch(r){}clearInterval(h.interval),genocide.genocide(n.pid),{"null":function(){p.error({reason:t,log:c}),m().then(e)},shutdown:p.shutdown,reboot:function(){p.reboot(),e()},update:function(){m(!0).then(function(t){t||p.reboot(),e()})}}[i]()}};n.on("close",function(e,t){d({event:"close",code:e,signal:t})}),n.on("disconnect",function(){d({event:"disconnect"})}),n.on("error",function(e){d({event:"error",error:e})}),n.on("exit",function(e,t){d({event:"exit",code:e,signal:t})});var h={alarm:new nappy.alarm(r.start.keepalive.margin*r.start.keepalive.interval,{sleep_threshold:r.start.keepalive.sleep_threshold}),interval:setInterval(function(){n.send({cmd:"keepalive"})},r.start.keepalive.interval)};h.alarm.then(function(){genocide.genocide(n.pid)}),n.on("message",function(e){"keepalive"===e.cmd?(n.started||(n.started=!0,n.send({cmd:"setup",version:version,id:o.id()}),p.start()),h.alarm.reset()):"shutdown"===e.cmd||"reboot"===e.cmd||"update"===e.cmd?(i=e.cmd,n.send({cmd:"goodnight"}),nappy.wait["for"](r.start.sentence).then(function(){n.buried||(i=null,genocide.genocide(n.pid))})):"message"===e.cmd&&p.message(e.message)}),u.message=function(e){n.send({cmd:"message",message:e})},u.bury=function(){d({event:"bury"})}}(new Date).getTime()-c.get("pull_last")>=r.start.autoupdate.threshold?m(!0).then(e):e()}}var nappy=require("nappy"),wrench=require("wrench"),confio=require("confio"),path=require("path"),request=require("request"),child_process=require("child_process"),randomstring=require("randomstring"),genocide=require("genocide"),fs=require("fs"),unzip=require("unzip"),version=require(path.resolve(__dirname,"..","package.json")).version,app={settings:{keepalive:{interval:500,margin:10,sleep_threshold:5e3},sentence:2e3},events:{message:function(){}},setup:function(){"use strict";var e=!1;return new Promise(function(t){app.keepalive={alarm:new nappy.alarm(app.settings.keepalive.margin*app.settings.keepalive.interval,{sleep_threshold:app.settings.keepalive.sleep_threshold})},app.keepalive.alarm.then(genocide.seppuku),process.on("message",function(n){"keepalive"===n.cmd?(app.keepalive.alarm.reset(),process.send({cmd:"keepalive"})):"setup"!==n.cmd||e?"message"===n.cmd&&app.events.message(n.message):(e=!0,t({id:n.id,version:n.version}))})})},shutdown:function(){"use strict";return new Promise(function(e){try{app.keepalive.alarm.abort()}catch(t){}nappy.wait["for"](app.settings.sentence).then(genocide.seppuku),process.send({cmd:"shutdown"}),process.on("message",function(t){"goodnight"===t.cmd&&e()})})},reboot:function(){"use strict";return new Promise(function(e){try{app.keepalive.alarm.abort()}catch(t){}nappy.wait["for"](app.settings.sentence).then(genocide.seppuku),process.send({cmd:"reboot"}),process.on("message",function(t){"goodnight"===t.cmd&&e()})})},update:function(){"use strict";return new Promise(function(e){try{app.keepalive.alarm.abort()}catch(t){}nappy.wait["for"](app.settings.sentence).then(genocide.seppuku),process.send({cmd:"update"}),process.on("message",function(t){"goodnight"===t.cmd&&e()})})},on:function(e,t){if(!(e in app.events))throw{code:2,description:"Event does not exist.",url:""};app.events[e]=t},message:function(e){process.send({cmd:"message",message:e})}};module.exports={pot:pot,app:app};