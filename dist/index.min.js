function pot(e,t,n){"use strict";var r={path_setup:{retry:1e3},setup:{retry:{min:1e3,max:6048e5}},pull:{retries:5},update:{ignore:{min:1e3,max:6048e5}},run:{keepalive:{interval:500},sentence:2e3}};if(!(this instanceof pot))throw{code:0,description:"Constructor must be called with new.",url:""};var o=this,i={root:e,app:path.resolve(e,"app"),resources:path.resolve(e,"resources")},u=t,c={local:n,remote:"origin/"+n},a=new confio.confio(i.root+"/potty.json",__dirname+"/../config/pot.json");o.path={root:function(){return i.root},app:function(){return i.app},resources:function(){return i.resources}},o.repository=function(){return u},o.branch={local:function(){return c.local},remote:function(){return c.remote}};var p=function(){var e=function(e){return new Promise(function(t,n){rimraf(e,function(){mkdirp(e,function(e){e?n(e):t()})})})};return new Promise(function(t){!function n(){e(i.app).then(function(){return e(i.resources)}).then(t)["catch"](function(){nappy.wait["for"](r.path_setup.retry).then(n)})}()})},s=function(){var e=function(){return nappy.wait.connection().then(function(){return nodegit.Clone(u,i.app,{checkoutBranch:c.local})})};return p().then(function(){return new Promise(function(t){nappy.wait.till(a.get("setup_last")+Math.min(Math.pow(2,a.get("setup_retries"))*r.setup.retry.min,r.setup.retry.max)).then(function(){try{a.set("setup_last",(new Date).getTime())}catch(n){}e().then(function(){try{a.set("setup_retries",0)}catch(e){}t()})["catch"](function(){try{a.set("setup_retries",a.get("setup_retries")+1)}catch(e){}s().then(t)})})})})},l=function(){var e=function(){return nappy.wait.connection().then(function(){return nodegit.Repository.open(i.app)}).then(function(e){return e.fetch("origin").then(function(){return e.mergeBranches(c.local,c.remote)})})};return new Promise(function(t){var n=0;!function o(){n<r.pull.retries?e().then(t)["catch"](function(){n++,o()}):s().then(t)}()}).then(function(){return nodegit.Repository.open(i.app)}).then(function(e){return e.getBranchCommit(c.local)}).then(function(e){var t=a.get("head")!==e.id().toString();try{a.set("head",e.id().toString())}catch(n){}return Promise.resolve(t)})},f=function(e){return!e&&(new Date).getTime()<a.get("pull_last")+Math.min(Math.pow(2,a.get("pull_retries"))*r.update.ignore.min,r.update.ignore.max)?Promise.resolve():l().then(function(e){try{e?a.set("pull_retries",0):a.set("pull_retries",a.get("pull_retries")+1),a.set("pull_last",(new Date).getTime())}catch(t){}})};o.run=function(){!function e(){var t=child_process.fork(i.app,{cwd:i.resources}),n=null,o=function(){t.buried||(t.buried=!0,t.kill(),{"null":function(){f().then(e)},shutdown:process.exit,reboot:e,update:function(){f(!0).then(e)}}[n]())};t.on("close",o),t.on("disconnect",o),t.on("error",o),t.on("exit",o);var u=new nappy.alarm(2*r.run.keepalive.interval);u.then(t.kill),t.on("message",function(e){"keepalive"===e.cmd?(u.reset(),t.send({cmd:"keepalive"})):("shutdown"===e.cmd||"reboot"===e.cmd||"update"===e.cmd)&&(n=e.cmd,t.send({cmd:"goodnight"}),nappy.wait["for"](r.run.sentence).then(function(){"executed"!==n&&(n=null,t.kill())}))})}()}}var nappy=require("nappy"),nodegit=require("nodegit"),rimraf=require("rimraf"),mkdirp=require("mkdirp"),confio=require("confio"),path=require("path"),child_process=require("child_process");module.exports={pot:pot};