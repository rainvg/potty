function pot(e,t,n,r){"use strict";var o={id:{length:16},path_setup:{retry:1e3},setup:{retry:{min:1e3,max:6048e5}},pull:{retries:5},update:{ignore:{min:1e3,max:6048e5}},start:{autoupdate:{threshold:6048e5},keepalive:{interval:500,margin:10,sleep_threshold:5e3},sentence:2e3,log:{max_length:1048576}}};if(!(this instanceof pot))throw{code:0,description:"Constructor must be called with new.",url:""};var i=this,s={root:e,app:path.resolve(e,"app"),resources:path.resolve(e,"resources")},a=t,c={local:n,remote:"origin/"+n},u=r||{},p=new confio.confio(s.root+"/potty.json",__dirname+"/../config/pot.json"),d={start:function(){},data:function(){},message:function(){},error:function(){},shutdown:function(){},reboot:function(){},update:function(){}},l={message:function(){},bury:function(){}};i.path={root:function(){return s.root},app:function(){return s.app},resources:function(){return s.resources}},i.repository=function(){return a},i.branch={local:function(){return c.local},remote:function(){return c.remote}},i.id=function(){if(""===p.get("id"))try{p.set("id",randomstring.generate(o.id.length))}catch(e){}return p.get("id")},i.on=function(e,t){if(!(e in d))throw{code:2,description:"Event does not exist.",url:""};d[e]=t},i.message=function(e){l.message(e)},i.bury=function(){l.bury()};var h=function(){var e=function(e){return new Promise(function(t,n){rimraf(e,function(){mkdirp(e,function(e){e?n(e):t()})})})};return new Promise(function(t){!function n(){e(s.app).then(function(){return e(s.resources)}).then(t)["catch"](function(){nappy.wait["for"](o.path_setup.retry).then(n)})}()})},g=function(){var e=function(){return nappy.wait.connection().then(function(){return nodegit.Clone(a,s.app,{checkoutBranch:c.local})})};return h().then(function(){return new Promise(function(t){nappy.wait.till(p.get("setup_last")+Math.min(Math.pow(2,p.get("setup_retries"))*o.setup.retry.min,o.setup.retry.max)).then(function(){try{p.set("setup_last",(new Date).getTime())}catch(n){}e().then(function(){try{p.set("setup_retries",0)}catch(e){}t()})["catch"](function(){try{p.set("setup_retries",p.get("setup_retries")+1)}catch(e){}g().then(t)})})})})},f=function(){var e=function(){return nappy.wait.connection().then(function(){return nodegit.Repository.open(s.app)}).then(function(e){return e.fetch("origin").then(function(){return e.mergeBranches(c.local,c.remote)})})};return new Promise(function(t){var n=0;!function r(){n<o.pull.retries?e().then(t)["catch"](function(){n++,r()}):g().then(t)}()}).then(function(){return nodegit.Repository.open(s.app)}).then(function(e){return e.getBranchCommit(c.local)}).then(function(e){var t=p.get("head")!==e.id().toString();try{p.set("head",e.id().toString())}catch(n){}return Promise.resolve(t)})},m=function(){return new Promise(function(e){nodegit.Repository.open(s.app).then(function(e){return nodegit.Checkout.head(e,{checkoutStrategy:nodegit.Checkout.STRATEGY.FORCE})}).then(e)["catch"](e)})},v=function(e){return m().then(function(){return!e&&(new Date).getTime()<p.get("pull_last")+Math.min(Math.pow(2,p.get("pull_retries"))*o.update.ignore.min,o.update.ignore.max)?Promise.resolve():f().then(function(e){try{e?(p.set("pull_retries",0),d.update()):p.set("pull_retries",p.get("pull_retries")+1),p.set("pull_last",(new Date).getTime())}catch(t){}return e})})};i.start=function(){function e(){var t=process.env;"ELECTRON_RUN_AS_NODE"in u&&(u.ELECTRON_RUN_AS_NODE?process.env.ELECTRON_RUN_AS_NODE=!0:delete process.env.ELECTRON_RUN_AS_NODE),process.env.POTTY=__filename;var n=child_process.spawn(process.argv[0],[s.app],{cwd:s.resources,detached:!0,stdio:["pipe","pipe","pipe","ipc"]});process.env=t;var r=null,a={stdout:"",stderr:""};n.stdout.on("data",function(e){d.data(e),a.stdout+=e,a.stdout.length>o.start.log.max_length&&(a.stdout=a.stdout.slice(a.stdout.length-o.start.log.max_length))}),n.stderr.on("data",function(e){a.stderr+=e,a.stderr.length>o.start.log.max_length&&(a.stderr=a.stderr.slice(a.stderr.length-o.start.log.max_length))});var c=function(t){if(!n.buried){l.message=function(){},l.bury=function(){},n.buried=!0;try{p.alarm.abort()}catch(o){}clearInterval(p.interval),genocide.genocide(n.pid),{"null":function(){d.error({reason:t,log:a}),v().then(e)},shutdown:d.shutdown,reboot:function(){d.reboot(),e()},update:function(){v(!0).then(function(t){t||d.reboot(),e()})}}[r]()}};n.on("close",function(e,t){c({event:"close",code:e,signal:t})}),n.on("disconnect",function(){c({event:"disconnect"})}),n.on("error",function(e){c({event:"error",error:e})}),n.on("exit",function(e,t){c({event:"exit",code:e,signal:t})});var p={alarm:new nappy.alarm(o.start.keepalive.margin*o.start.keepalive.interval,{sleep_threshold:o.start.keepalive.sleep_threshold}),interval:setInterval(function(){n.send({cmd:"keepalive"})},o.start.keepalive.interval)};p.alarm.then(function(){genocide.genocide(n.pid)}),n.on("message",function(e){"keepalive"===e.cmd?(n.started||(n.started=!0,n.send({cmd:"setup",version:version,id:i.id()}),d.start()),p.alarm.reset()):"shutdown"===e.cmd||"reboot"===e.cmd||"update"===e.cmd?(r=e.cmd,n.send({cmd:"goodnight"}),nappy.wait["for"](o.start.sentence).then(function(){n.buried||(r=null,genocide.genocide(n.pid))})):"message"===e.cmd&&d.message(e.message)}),l.message=function(e){n.send({cmd:"message",message:e})},l.bury=function(){c({event:"bury"})}}(new Date).getTime()-p.get("pull_last")>=o.start.autoupdate.threshold?v(!0).then(e):e()}}var nappy=require("nappy"),nodegit=require("nodegit"),rimraf=require("rimraf"),mkdirp=require("mkdirp"),confio=require("confio"),path=require("path"),child_process=require("child_process"),randomstring=require("randomstring"),genocide=require("genocide"),version=require("../package.json").version,app={settings:{keepalive:{interval:500,margin:10,sleep_threshold:5e3},sentence:2e3},events:{message:function(){}},setup:function(){"use strict";var e=!1;return new Promise(function(t){app.keepalive={alarm:new nappy.alarm(app.settings.keepalive.margin*app.settings.keepalive.interval,{sleep_threshold:app.settings.keepalive.sleep_threshold})},app.keepalive.alarm.then(genocide.seppuku),process.on("message",function(n){"keepalive"===n.cmd?(app.keepalive.alarm.reset(),process.send({cmd:"keepalive"})):"setup"!==n.cmd||e?"message"===n.cmd&&app.events.message(n.message):(e=!0,t({id:n.id,version:n.version}))})})},shutdown:function(){"use strict";return new Promise(function(e){try{app.keepalive.alarm.abort()}catch(t){}nappy.wait["for"](app.settings.sentence).then(genocide.seppuku),process.send({cmd:"shutdown"}),process.on("message",function(t){"goodnight"===t.cmd&&e()})})},reboot:function(){"use strict";return new Promise(function(e){try{app.keepalive.alarm.abort()}catch(t){}nappy.wait["for"](app.settings.sentence).then(genocide.seppuku),process.send({cmd:"reboot"}),process.on("message",function(t){"goodnight"===t.cmd&&e()})})},update:function(){"use strict";return new Promise(function(e){try{app.keepalive.alarm.abort()}catch(t){}nappy.wait["for"](app.settings.sentence).then(genocide.seppuku),process.send({cmd:"update"}),process.on("message",function(t){"goodnight"===t.cmd&&e()})})},on:function(e,t){if(!(e in app.events))throw{code:2,description:"Event does not exist.",url:""};app.events[e]=t},message:function(e){process.send({cmd:"message",message:e})}};module.exports={pot:pot,app:app};