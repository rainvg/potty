var nappy=require("nappy"),wrench=require("wrench"),confio=require("confio"),path=require("path"),request=require("request"),child_process=require("child_process"),randomstring=require("randomstring"),genocide=require("genocide"),fs=require("fs"),os=require("os"),unzip=require("unzip"),commander=require("commander"),version=require(path.resolve(__dirname,"..","package.json")).version;if(require.main!==module)module.exports=function e(t,n,r){"use strict";var o={id:{length:16},path_setup:{retry:1e3},remote_version:{retry:1e3},fetch:{retry:{min:1e3,max:6048e5},tmp_file_length:16},update:{retry:{min:1e3,max:6048e5}},start:{autoupdate:{threshold:6048e5},keepalive:{interval:500,margin:10,sleep_threshold:5e3},sentence:2e3,log:{max_length:1048576}}};if(!(this instanceof e))throw{code:0,description:"Constructor must be called with new.",url:""};var s=this,i={root:t,app:path.resolve(t,"app"),resources:path.resolve(t,"resources")},a=n,c=r||{},u=new confio.confio(path.resolve(i.root,"potty.json"),path.resolve(__dirname,"..","config","pot.json")),d={start:function(){},data:function(){},message:function(){},error:function(){},shutdown:function(){},reboot:function(){},update:function(){}},p={message:function(){},bury:function(){}};s.path={root:function(){return i.root},app:function(){return i.app},resources:function(){return i.resources}},s.remote=function(){return a},s.id=function(){if(""===u.get("id"))try{u.set("id",randomstring.generate(o.id.length))}catch(e){}return u.get("id")},s.on=function(e,t){if(!(e in d))throw{code:2,description:"Event does not exist.",url:""};d[e]=t},s.message=function(e){p.message(e)},s.bury=function(){p.bury()};var f=function(){return new Promise(function(e){request("https://api.ipify.org",function(t,n,r){e(!t&&200===n.statusCode&&/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$|^(([a-zA-Z]|[a-zA-Z][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z]|[A-Za-z][A-Za-z0-9\-]*[A-Za-z0-9])$|^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$/.test(r)?!0:!1)})})},l=function(){return new Promise(function(e){!function t(){try{for(var n in i)wrench.mkdirSyncRecursive(i[n]);"win32"===process.platform&&child_process.exec("attrib +h "+i.root),e()}catch(r){nappy.wait["for"](o.path_setup.retry).then(t)}}()})},m=function(e){return new Promise(function(t,n){try{wrench.rmdirSyncRecursive(i.app),fs.createReadStream(e).pipe(unzip.Extract({path:i.app})).on("finish",t).on("error",n)}catch(r){n()}})},h=function(){var e=function(){return new Promise(function(e,t){nappy.wait.connection().then(function(){request(a+"?id="+s.id(),function(n,r,s){(n||200!==r.statusCode)&&t(n);try{var i=JSON.parse(s);i.tmp={},i.tmp.path=path.resolve(os.tmpdir(),randomstring.generate(o.fetch.tmp_file_length)),i.tmp.handle=fs.createWriteStream(i.tmp.path),request(i.latest.url).on("response",function(e){i.tmp.response=e}).on("error",t).on("complete",function(){200!==i.tmp.response.statusCode?t(i.tmp.response):e(i.tmp.path)}).pipe(i.tmp.handle)}catch(n){t(n)}})})})};return new Promise(function(t){!function n(){l().then(function(){return nappy.wait.till(u.get("fetch_last")+Math.min(Math.pow(2,u.get("fetch_retries"))*o.fetch.retry.min,o.fetch.retry.max))}).then(function(){try{u.set("fetch_last",(new Date).getTime())}catch(e){}}).then(e).then(m).then(function(){try{u.set("fetch_retries",0)}catch(e){}t()})["catch"](function(){try{u.set("fetch_retries",u.get("fetch_retries")+1)}catch(e){}n()})}()})},g=function(){try{return require(path.resolve(i.app,"package.json")).version}catch(e){return""}},v=function(){var e=function(){return new Promise(function(e,t){request(a+"?id="+s.id(),function(n,r,o){(n||200!==r.statusCode)&&t(n);try{var s=JSON.parse(o);e(s.version)}catch(n){t(n)}})})};return new Promise(function(t){!function n(){e().then(t)["catch"](function(){nappy.wait["for"](o.remote_version.retry).then(n)})}()})},_=function(e){return new Promise(function(t){if(!e&&(new Date).getTime()<u.get("update_last")+Math.min(Math.pow(2,u.get("update_vain"))*o.update.retry.min,o.update.retry.max))return void t(!1);try{u.set("update_last",(new Date).getTime())}catch(n){}v().then(function(e){if(e===g()){try{u.set("update_vain",u.get("update_vain")+1)}catch(n){}t(!1)}else{try{u.set("update_vain",0)}catch(n){}h().then(function(){t(!0)})}})})},w=function(e){return new Promise(function(t){m(e).then(function(){t(!0)})["catch"](function(){_(!0).then(t)})})};s.start=function(){function e(){var t=process.env;"ELECTRON_RUN_AS_NODE"in c&&(c.ELECTRON_RUN_AS_NODE?process.env.ELECTRON_RUN_AS_NODE=!0:delete process.env.ELECTRON_RUN_AS_NODE);var n=child_process.spawn(process.argv[0],[__filename,i.app],{cwd:i.resources,detached:!0,stdio:["pipe","pipe","pipe","ipc"]});process.env=t;var r=null,a=null,u={stdout:"",stderr:""};n.stdout.on("data",function(e){d.data(e),u.stdout+=e,u.stdout.length>o.start.log.max_length&&(u.stdout=u.stdout.slice(u.stdout.length-o.start.log.max_length))}),n.stderr.on("data",function(e){u.stderr+=e,u.stderr.length>o.start.log.max_length&&(u.stderr=u.stderr.slice(u.stderr.length-o.start.log.max_length))});var f=function(t){if(!n.buried){p.message=function(){},p.bury=function(){},n.buried=!0;try{l.alarm.abort()}catch(o){}clearInterval(l.interval),genocide.genocide(n.pid),{"null":function(){d.error({reason:t,log:u}),_().then(e)},shutdown:d.shutdown,reboot:function(){d.reboot(),e()},update:function(){_(!0).then(function(t){t||d.reboot(),e()})},install:function(){w(a.path).then(function(t){t||d.reboot(),e()})}}[r]()}};n.on("close",function(e,t){f({event:"close",code:e,signal:t})}),n.on("disconnect",function(){f({event:"disconnect"})}),n.on("error",function(e){f({event:"error",error:e})}),n.on("exit",function(e,t){f({event:"exit",code:e,signal:t})});var l={alarm:new nappy.alarm(o.start.keepalive.margin*o.start.keepalive.interval,{sleep_threshold:o.start.keepalive.sleep_threshold}),interval:setInterval(function(){n.send({cmd:"keepalive"})},o.start.keepalive.interval)};l.alarm.then(function(){genocide.genocide(n.pid)}),n.on("message",function(e){"keepalive"===e.cmd?(n.started||(n.started=!0,n.send({cmd:"setup",id:s.id()}),d.start()),l.alarm.reset()):"shutdown"===e.cmd||"reboot"===e.cmd||"update"===e.cmd||"install"===e.cmd?(r=e.cmd,a=e.meta,n.send({cmd:"goodnight"}),nappy.wait["for"](o.start.sentence).then(function(){n.buried||(r=null,genocide.genocide(n.pid))})):"message"===e.cmd&&d.message(e.message)}),p.message=function(e){n.send({cmd:"message",message:e})},p.bury=function(){f({event:"bury"})}}f().then(function(t){t?_().then(e):e()})}};else if(commander.version(version).option("-t, --test","Run potty to test app").parse(process.argv),1!==commander.args.length)console.log("App path required."),genocide.seppuku();else try{var app=require(commander.args[0]);if("function"!=typeof app)throw{code:3,description:"App is not a function.",url:""};if(commander.test)app({id:"[test]",version:version,shutdown:function(){return console.log("Shutdown requested."),Promise.resolve()},reboot:function(){return console.log("Reboot requested."),Promise.resolve()},update:function(){return console.log("Update requested."),Promise.resolve()},install:function(e){return console.log("Install requested for",e),Promise.resolve()},message:function(e){console.log("Message dispatched:",e)},on:function(e){if(!(e in _events))throw{code:2,description:"Event does not exist.",url:""};console.log("Subscribed to",e,"(will never be fired).")}});else{var settings={keepalive:{interval:500,margin:10,sleep_threshold:5e3},sentence:2e3},_events={message:function(){}},_keepalive={alarm:new nappy.alarm(settings.keepalive.margin*settings.keepalive.interval,{sleep_threshold:settings.keepalive.sleep_threshold})},_started=!1;_keepalive.alarm.then(genocide.seppuku),process.on("message",function(e){if("keepalive"===e.cmd)app.keepalive.alarm.reset(),process.send({cmd:"keepalive"});else if("setup"!==e.cmd||_started)"message"===e.cmd&&_events.message(e.message);else{_started=!0;var t=function(){try{_keepalive.alarm.abort()}catch(e){}nappy.wait["for"](settings.sentence).then(genocide.seppuku)};app({id:e.id,version:version,shutdown:function(){"use strict";return new Promise(function(e){t(),process.send({cmd:"shutdown"}),process.on("message",function(t){"goodnight"===t.cmd&&e()})})},reboot:function(){"use strict";return new Promise(function(e){t(),process.send({cmd:"reboot"}),process.on("message",function(t){"goodnight"===t.cmd&&e()})})},update:function(){"use strict";return new Promise(function(e){t(),process.send({cmd:"update"}),process.on("message",function(t){"goodnight"===t.cmd&&e()})})},install:function(e){"use strict";return new Promise(function(n){t(),process.send({cmd:"install",meta:{path:e}}),process.on("message",function(e){"goodnight"===e.cmd&&n()})})},on:function(e,t){if(!(e in _events))throw{code:2,description:"Event does not exist.",url:""};_events[e]=t},message:function(e){process.send({cmd:"message",message:e})}})}})}}catch(error){console.log("Exiting with error",error),genocide.seppuku()}