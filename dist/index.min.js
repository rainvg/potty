function pot(e,t,n){"use strict";var r={id:{length:16},path_setup:{retry:1e3},setup:{retry:{min:1e3,max:6048e5}},pull:{retries:5},update:{ignore:{min:1e3,max:6048e5}},start:{keepalive:{interval:500},sentence:2e3,log:{max_length:1048576}}};if(!(this instanceof pot))throw{code:0,description:"Constructor must be called with new.",url:""};var o=this,i={root:e,app:path.resolve(e,"app"),resources:path.resolve(e,"resources")},s=t,a={local:n,remote:"origin/"+n},c=new confio.confio(i.root+"/potty.json",__dirname+"/../config/pot.json"),u={start:function(){},data:function(){},message:function(){},error:function(){},shutdown:function(){},reboot:function(){},update:function(){}},p={message:function(){},bury:function(){}};o.path={root:function(){return i.root},app:function(){return i.app},resources:function(){return i.resources}},o.repository=function(){return s},o.branch={local:function(){return a.local},remote:function(){return a.remote}},o.id=function(){if(""===c.get("id"))try{c.set("id",randomstring.generate(r.id.length))}catch(e){}return c.get("id")},o.on=function(e,t){if(!(e in u))throw{code:2,description:"Event does not exist.",url:""};u[e]=t},o.message=function(e){p.message(e)},o.bury=function(){p.bury()};var l=function(){var e=function(e){return new Promise(function(t,n){rimraf(e,function(){mkdirp(e,function(e){e?n(e):t()})})})};return new Promise(function(t){!function n(){e(i.app).then(function(){return e(i.resources)}).then(t)["catch"](function(){nappy.wait["for"](r.path_setup.retry).then(n)})}()})},d=function(){var e=function(){return nappy.wait.connection().then(function(){return nodegit.Clone(s,i.app,{checkoutBranch:a.local})})};return l().then(function(){return new Promise(function(t){nappy.wait.till(c.get("setup_last")+Math.min(Math.pow(2,c.get("setup_retries"))*r.setup.retry.min,r.setup.retry.max)).then(function(){try{c.set("setup_last",(new Date).getTime())}catch(n){}e().then(function(){try{c.set("setup_retries",0)}catch(e){}t()})["catch"](function(){try{c.set("setup_retries",c.get("setup_retries")+1)}catch(e){}d().then(t)})})})})},f=function(){var e=function(){return nappy.wait.connection().then(function(){return nodegit.Repository.open(i.app)}).then(function(e){return e.fetch("origin").then(function(){return e.mergeBranches(a.local,a.remote)})})};return new Promise(function(t){var n=0;!function o(){n<r.pull.retries?e().then(t)["catch"](function(){n++,o()}):d().then(t)}()}).then(function(){return nodegit.Repository.open(i.app)}).then(function(e){return e.getBranchCommit(a.local)}).then(function(e){var t=c.get("head")!==e.id().toString();try{c.set("head",e.id().toString())}catch(n){}return Promise.resolve(t)})},m=function(e){return!e&&(new Date).getTime()<c.get("pull_last")+Math.min(Math.pow(2,c.get("pull_retries"))*r.update.ignore.min,r.update.ignore.max)?Promise.resolve():f().then(function(e){try{e?(c.set("pull_retries",0),u.update()):c.set("pull_retries",c.get("pull_retries")+1),c.set("pull_last",(new Date).getTime())}catch(t){}return e})};o.start=function(){!function e(){var t=child_process.fork(i.app,{cwd:i.resources,silent:!0,env:{POTTY:__filename}}),n=null,s={stdout:"",stderr:""};t.stdout.on("data",function(e){u.data(e),s.stdout+=e,s.stdout.length>r.start.log.max_length&&(s.stdout=s.stdout.slice(s.stdout.length-r.start.log.max_length))}),t.stderr.on("data",function(e){s.stderr+=e,s.stderr.length>r.start.log.max_length&&(s.stderr=s.stderr.slice(s.stderr.length-r.start.log.max_length))});var a=function(r){t.buried||(p.message=function(){},p.bury=function(){},t.buried=!0,t.kill(),{"null":function(){u.error({reason:r,log:s}),m().then(e)},shutdown:u.shutdown,reboot:function(){u.reboot(),e()},update:function(){m(!0).then(function(t){t||u.reboot(),e()})}}[n]())};t.on("close",function(e,t){a({event:"close",code:e,signal:t})}),t.on("disconnect",function(){a({event:"disconnect"})}),t.on("error",function(e){a({event:"error",error:e})}),t.on("exit",function(e,t){a({event:"exit",code:e,signal:t})});var c=new nappy.alarm(2*r.start.keepalive.interval);c.then(t.kill),t.on("message",function(e){"keepalive"===e.cmd?(t.started||(t.started=!0,t.send({cmd:"setup",version:version,id:o.id()}),u.start()),c.reset(),t.send({cmd:"keepalive"})):"shutdown"===e.cmd||"reboot"===e.cmd||"update"===e.cmd?(n=e.cmd,t.send({cmd:"goodnight"}),nappy.wait["for"](r.start.sentence).then(function(){t.buried||(n=null,t.kill())})):"message"===e.cmd&&u.message(e.message)}),p.message=function(e){t.send({cmd:"message",message:e})},p.bury=function(){a({event:"bury"})}}()}}var nappy=require("nappy"),nodegit=require("nodegit"),rimraf=require("rimraf"),mkdirp=require("mkdirp"),confio=require("confio"),path=require("path"),child_process=require("child_process"),randomstring=require("randomstring"),version=require("../package.json").version,app={settings:{keepalive:{interval:500},sentence:2e3},events:{message:function(){}},setup:function(){"use strict";var e=!1;return new Promise(function(t){app.keepalive={alarm:new nappy.alarm(2*app.settings.keepalive.interval),interval:setInterval(function(){process.send({cmd:"keepalive"})},app.settings.keepalive.interval)},app.keepalive.alarm.then(process.exit),process.on("message",function(n){"keepalive"===n.cmd?app.keepalive.alarm.reset():"setup"!==n.cmd||e?"message"===n.cmd&&app.events.message(n.message):(e=!0,t({id:n.id,version:n.version}))})})},shutdown:function(){"use strict";return new Promise(function(e){app.keepalive.alarm.abort(),clearInterval(app.keepalive.interval),nappy.wait["for"](app.settings.sentence).then(process.exit),process.send({cmd:"shutdown"}),process.on("message",function(t){"goodnight"===t.cmd&&e()})})},reboot:function(){"use strict";return new Promise(function(e){app.keepalive.alarm.abort(),clearInterval(app.keepalive.interval),nappy.wait["for"](app.settings.sentence).then(process.exit),process.send({cmd:"reboot"}),process.on("message",function(t){"goodnight"===t.cmd&&e()})})},update:function(){"use strict";return new Promise(function(e){app.keepalive.alarm.abort(),clearInterval(app.keepalive.interval),nappy.wait["for"](app.settings.sentence).then(process.exit),process.send({cmd:"update"}),process.on("message",function(t){"goodnight"===t.cmd&&e()})})},on:function(e,t){if(!(e in app.events))throw{code:2,description:"Event does not exist.",url:""};app.events[e]=t},message:function(e){process.send({cmd:"message",message:e})}};module.exports={pot:pot,app:app};