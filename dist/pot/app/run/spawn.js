var child_process=require("child_process"),__logger__=require("../../../logger"),settings={log:{size:{max:1048576}}},__spawn__=function(t){"use strict";var e=process.env;for(var s in t.env)"undefined"==typeof t.env[s]?delete process.env[s]:process.env[s]=t.env[s];__logger__.log("Spawning child process.");var n=child_process.spawn(t.command,t.args,{cwd:t.cwd,detached:!0,stdio:["pipe","pipe","pipe","ipc"]});return process.env=e,n},__setup_log__=function(t){"use strict";__logger__.log("Binding events to child process.");var e={stdout:"",stderr:"",events:{stdout:[],stderr:[]}},s=function(t,s){if(!(t in e.events))throw{code:2,description:"Event does not exist.",url:""};e.events[t].forEach(function(t){t(s)})};return t.stdout.on("data",function(t){t.toString("utf8").split(/\r?\n/).forEach(function(t){t.length&&s("stdout",t)}),e.stdout+=t,e.stdout.length>settings.log.size.max&&(e.stdout=e.stdout.slice(e.stdout.length-settings.log.size.max))}),t.stderr.on("data",function(t){t.toString("utf8").split(/\r?\n/).forEach(function(t){t.length&&s("stderr",t)}),e.stderr+=t,e.stderr.length>settings.log.size.max&&(e.stderr=e.stderr.slice(e.stderr.length-settings.log.size.max))}),t.log={stdout:function(){return e.stdout},stderr:function(){return e.stderr},on:function(t,s){if(!(t in e.events))throw{code:2,description:"Event does not exist.",url:""};e.events[t].push(s)}},t};module.exports=function(t){"use strict";return __setup_log__(__spawn__(t))};