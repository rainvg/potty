var nappy=require("nappy"),needle=require("needle"),ospath=require("path"),randomstring=require("randomstring"),os=require("os"),fs=require("fs-extra"),__unzip__=require("../filesystem/unzip.js"),__logger__=require("../../logger");module.exports=function(e,t,n){"use strict";var r={filename:{length:16},needle:{open_timeout:1e4,read_timeout:6e4}},o=function(){return new Promise(function(e,o){nappy.wait.connection().then(function(){__logger__.log("Attempting download."),n.load().then(function(n){var i={path:ospath.resolve(t.root(),"release.zip")};__logger__.log("Downloading",n.latest.url,"to",i.path),needle.get(n.latest.url,r.needle,function(t,n){(t||200!==n.statusCode)&&(__logger__.err("Failed download:",t||n.statusCode),o(t)),fs.writeFile(i.path,n.body,function(t){t?o(t):(__logger__.log("Download succeeded"),e(i.path))})})})})})};return new Promise(function(n){!function r(){__logger__.log("Fetching."),t.setup().then(e.fetch.wait).then(function(){return e.fetch.now(),o()}).then(function(e){return __unzip__(t,e)}).then(function(){e.fetch.reset(),n()})["catch"](function(){__logger__.err("Fetch failed. Retrying."),e.fetch.increment(),r()})}()})};