var nappy=require("nappy"),needle=require("needle"),ospath=require("path"),randomstring=require("randomstring"),os=require("os"),__config__=require("../config"),__remote__=require("./remote.js"),__path__=require("../filesystem/path.js"),__unzip__=require("../filesystem/unzip.js"),__logger__=require("../../logger");module.exports=function(e,n,t){if(!(e instanceof __config__))throw{code:1,description:"An instance of config is required.",url:""};if(!(n instanceof __path__))throw{code:1,description:"An instance of path is required.",url:""};if(!(t instanceof __remote__))throw{code:1,description:"An instance of remote is required.",url:""};var r={filename:{length:16}},o=function(){return new Promise(function(e,n){nappy.wait.connection().then(function(){__logger__.log("Attempting download."),t.load().then(function(t){var o={path:ospath.resolve(os.tmpdir(),randomstring.generate(r.filename.length))};__logger__.log("Downloading",t.latest.url,"to",o.path),needle.get(t.latest.url,{output:o.path},function(t,r){(t||200!==r.statusCode)&&(__logger__.err("Failed download:",t||r.statusCode),n(t)),__logger__.log("Download succeeded"),e(o.path)})})})})};return new Promise(function(t){!function r(){__logger__.log("Fetching."),n.setup().then(e.fetch.wait).then(function(){return e.fetch.now(),o()}).then(function(e){return __unzip__(n,e)}).then(function(){e.fetch.reset(),t()})["catch"](function(){__logger__.err("Fetch failed. Retrying."),e.fetch.increment(),r()})}()})};